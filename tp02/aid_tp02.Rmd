---
title: "AID TP02"
author: "German Beldorati Stark"
output:
  html_document:
    df_print: paged
    highlight: kate
    theme:
      version: 4
      code_font: 
        google: JetBrains Mono
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 72
---

```{r}
library(tidyverse)
theme_set(theme_classic())
```

# cargo datos

Transformo la variable `id` en un `factor` porque no es numérica realmente. Transformo
las variables `character` en `factor` manualmente, ya que `readxl::read_excel` 
no tiene argumento `stringAsFactors`.

Estas transformaciones las hago porque tiene más sentido la descriptiva sobre factores.
En todos los casos las variables pueden tomar uno de un conjunto finito de niveles.

```{r}
d <- readxl::read_excel("dataset.xls",) %>% janitor::clean_names() %>%
  mutate(across(where(is.character), factor),
         id = factor(id),
         color = factor(color, levels = c("ROJO", "VERDE", "AZUL", "VIOLETA")))
```

# Tipos de variables

Categóricas: `r d %>% select(where(is.character) | where(is.factor)) %>% names()`

Cuantitativas: `r d %>% select(where(is.numeric), -id) %>% names()`

# descriptiva

En las variables categóricas vemos que no tenemos ningún `NA`, lo cual es bueno.
Sólo tenemos un problema en la variable `tiene_pin`, que debería ser SI/NO, pero hay
una tercera opción, "2", con 65 observaciones. El resto de las variables tienen buena
pinta a orden cero.

En la variables cuantitativas, la variable `edad` tiene al menos un _outlier_, de 900 años, y lo mismo para la variable antiguedad, con 337. Luego en la variable `consumo_tc` tenemos al menos un _outlier_: un consumo del orden de 10^9, lo cual probablemente no tenga sentido. La columna `mov90_cta` tiene un máximo bastante mas alto que la media, pero en principio podría ser una cuenta muy utilizada (comercial, por ejemplo). Por último, en la columna `sueldos` tenemos muchas observaciones faltantes, con 13298 `NA`.


```{r}
d %>% skimr::skim()
```

# biplots

Primero hago un gráfico con todas las combinaciones, y coloreando según el la variable
`color`. Esta figura, asi como está, no es muy informativa, ya que es muy difícil de interpretar, 
por lo que más abajo la vamos a ir partiendo.

```{r}
d %>% select(-id) %>%  GGally::ggpairs(aes(color = color), showStrips = T)
```

## cuantitativas

Por un lado graficamos las variables cuantitativas:

```{r}
d %>% select(where(is.numeric)) %>% GGally::ggpairs()
```

En la columna correcpondiente a edad vemos claramente un grupo de observaciones muy extremas.
Podemos graficarlo como boxplot, separando por color, para facilitar la visualización. 
Vemos que hay _outliers_ de edades en todas las categorías. 

Asumiendo que se tratan de personas físicas, y dado que la persona mas longeva en 
Argentina tiene apenas [114 años](https://gerontology.wikia.org/wiki/List_of_oldest_people_from_Argentina),
usamos  ese número como _cutoff_, y eliminamos las observaciones superiores. 
Probablemente  sea una sobreestimación, pero prefiero una aproximación conservadora.

```{r}
d %>% ggplot(aes(color, edad, color = color)) +
  geom_boxplot() +
  scale_y_continuous(n.breaks = 10)

d %>% filter(edad <= 114) -> d
```

Grafico las cuantitativas nuevamente y vemos que la columna de edad está mas linda.

```{r}
d %>% select(where(is.numeric)) %>% GGally::ggpairs()
```

Con respecto a antiguedad, vemos que hay un subgrupo muy separado de los otros (por
sobre los 300 meses). Grafico en boxplot, separando por color y graficando los outliers
independientemente, con un poco de jitter, para tener una idea de que pasa. 

En las cuatro clases hay una concentracion de antiguedades alrededor de los 284 meses y otra a los 337,
lo cual de mínima es llamativo. Un hipótesis es que tengamos un faltante de datos con antiguedades
entre 284 y 337. Hipotetizando más aún, quizá esas antiguedades intermedias fueron
colapsadas en 284 y 337.

```{r}
d %>% ggplot(aes(color, antiguedad, color = color)) +
  geom_point(aes(alpha = I(antiguedad) / 700), position = "jitter", color = "gray" ) + 
  geom_boxplot(outlier.shape = NA, alpha = 0) +
  geom_hline(yintercept = 284, linetype = "dashed", alpha = 0.3) +
  geom_hline(yintercept = 337, linetype = "dashed", alpha = 0.3) +
  scale_y_continuous(n.breaks = 10)
```

Con respecto a la variable `consumo_tc`, aproximadamente la mitad de los clientes
en la base no usaron la tarjeta en el mes de análisis (o al menos no está reportado).
Para el resto, transformo logaritmicamente para facilitar la visualizacion de las
distribuciones en un boxplot, de nuevo separado por colores. Ademas, grafico los datos encima.
Vemos que el alto consumo de tarjeta no era un _outlier_! Quizá los numeros enormes
puedan explicarse por la unidad usada, que desconocemos.

Otra opción es que todas esas observaciones sean _outliers_, por error multiplicadas
por un factor grande.

```{r}
filter(d, consumo_tc > 0) %>% ggplot(aes(color, consumo_tc)) + 
  geom_point(aes(alpha = I(log(consumo_tc)) / 50), position = "jitter", color = "gray") + 
  geom_boxplot(alpha = 0) +
  scale_y_log10()
```


## categoricas

Como mencionamos antes, la variable `tiene_pin` tiene un nivel extra incorrecto.
Lo elimino para simplificar el gráfico (son sólo 65 observaciones, en 18000).

```{r}
d %>%
  select(where(is.factor), -id) %>% 
  filter(tiene_pin != 2) %>% 
  GGally::ggpairs(aes(color = color), showStrips = T)
```

Graficando ese grupo por separado, contra todas las cuantitativas, vemos que el unico
detalle notable es que todos los casos corresponden a cuentas cuyos sueldos no están
en la base de datos. Pero notable hasta ahí, porque esa columna tiene un 26% de _complete_rate_.

```{r}
d %>%
  select(where(is.numeric), tiene_pin) %>%
  filter(tiene_pin == 2) %>%
  GGally::ggpairs()
```

El resto de las categóricas no parece tener nada raro. Y al graficarlas contra las
cuantitativas nada me llama la atención particularmente.

# outliers

En resumen, tenemos outliers en la columna `edad`, que eliminamos tomando como _cutoff_ la edad
de la persona mas longeva alguna vez registrada en Argentina. 

En la columna `tiene_pin` tenemos unas ~65 observaciones con un nivel mal asignado.
El resto de las variables en esas observaciones tienen pinta normal, por lo que 
les asignaria `NA` en la variable `tiene_pin` y listo.

